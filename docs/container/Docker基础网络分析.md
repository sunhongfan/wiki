# Docker 数据包实践

## 背景

在回顾 `Docker` 的知识点的时候,总会依赖与书上讲的, 同一个(network namespace) 中的容器可以互相通信, 容器可以通过 Docker0 转发数据包直接与互联网通信. 等等知识点, 可是还是不知道数据包在发出的时候,都经过了什么,修改了什么.这里主要研究一下 `Docker` 数据包与 `iptables` 规则的联系.



## 前提准备

Docker 每个版本的生成的默认规则可能会有出入(自定义china名称不一致)

Docker version : 20.10.0-dev

iptables:  v1.8.7 (legacy)

> 为了实验环境的纯净,这里重置了所有 iptbales 规则,并由 Docker 重新生成默认规则.



## Docker 初始网络

在启动 Docker 服务后,Docker 会生成一个 Docker0 的网络设备和做一些其他初始化配置:

Docker0 是一个虚拟网桥设备, 工作在 Docker 的 bridge 模式中,Docker0 它不但可以二层转发包，还可以将包送到用户层进行处理, 在我们尚未创建 container 的时候，docker0 以一个 Linux 网络设备的身份存在, 并且 Linux 虚拟网桥可以配置IP，可以作为在三层网络上的一个 Gateway, 与其他网络设备可以在三层互相通信,前提是开启了核心转发功能



1. 网桥

   ```bash
   $ brctl show
   bridge name     bridge id               STP enabled     interfaces
   docker0         8000.0242e8ddb4a1       no
   ```

2. 网络设备

   ```bash
   $ ip link show docker0
   3: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN mode DEFAULT group default
       link/ether 02:42:e8:dd:b4:a1 brd ff:ff:ff:ff:ff:ff
   ```

3. 网卡

   ```bash
   $ ip addr show docker0
   3: docker0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default
       link/ether 02:42:e8:dd:b4:a1 brd ff:ff:ff:ff:ff:ff
       inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
          valid_lft forever preferred_lft forever
       inet6 fe80::42:e8ff:fedd:b4a1/64 scope link
          valid_lft forever preferred_lft forever
   ```

4. 数据转发

   ```bash
   $ cat /proc/sys/net/ipv4/ip_forward
   1
   ```

5. 路由表

   ```bash
   $ ip route
   default via 10.211.55.1 dev enp0s5 proto dhcp src 10.211.55.8 metric 1002
   10.211.55.0/24 dev enp0s5 proto dhcp scope link src 10.211.55.8 metric 1002
   172.17.0.0/16 dev docker0 proto kernel scope link src 172.17.0.1 linkdown
   ```



## iptables 规则

iptables在容器网络中最重要的两个功能：

1. 限制 `container` 间的通信
2. 将 `container` 到外部网络包的源地址换成宿主主机地址(MASQUERADE)



### filter 规则

```bash
# 创建了一些默认的 china
iptables -N DOCKER
iptables -N DOCKER-ISOLATION-STAGE-1
iptables -N DOCKER-ISOLATION-STAGE-2
iptables -N DOCKER-USER

# 首先将经过 Filter 表中的数据包,交由 DOCKER-USER 链.
iptables -A FORWARD -j DOCKER-USER
# 接下来将数据包交由 DOCKER-ISOLATION-STAGE-1.
iptables -A FORWARD -j DOCKER-ISOLATION-STAGE-1
# 如果出口是 Docker 0 ,且数据包的连接状态是 RELATED,ESTABLISHED 则放行此数据包
iptables -A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# 如果出口是 Docker0 则交由 DOCKER 链进行处理, Docker 链中没有 Return 操作就会触发默认策略
iptables -A FORWARD -o docker0 -j DOCKER
# 如果是从 Docker 0 发往其他主机的数据包 则放行
iptables -A FORWARD -i docker0 ! -o docker0 -j ACCEPT
# 如果是容器内部通信则需要进过此规则
iptables -A FORWARD -i docker0 -o docker0 -j ACCEPT

# 这个链接接收到父链中转交的数据包, 指定, 入口是 docker,且出口非 Docker0 则交由 DOCKER-ISOLATION-STAGE-2 处理
iptables -A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
# 返回到主链中
iptables -A DOCKER-ISOLATION-STAGE-1 -j RETURN
# 这里判断 如果数据包的出口是 Docker 0 则会执行 DROP 操作.
iptables -A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
# 返回主链
iptables -A DOCKER-ISOLATION-STAGE-2 -j RETURN
# 返回主链
iptables -A DOCKER-USER -j RETURN
```





## 配置 iptables Log

通过让 `iptables` 输出 `Log` 来判断数据包的流向.

1. 加载 `iptables` 日志模块
2. 在 `raw:PREROUTING` 添加追踪的数据包

```bash
# 起初通过 LOG 来匹配日志, 但是需要一条条的来配置,麻烦容易出错.

# 采用 TRACE 方式来跟踪数据包
$ modprobe nf_log_ipv4
$ sysctl net.netfilter.nf_log.2
net.netfilter.nf_log.2 = nf_log_ipv4


# 添加追踪请求
iptables -t raw -A PREROUTING -p icmp -j TRACE
iptables -t raw -A PREROUTING -p tcp --dport 12345 -j TRACE
```



## 启动测试容器

c1: 启动一个 端口为 12580 的 http 服务

c2: 启动一个 busybox 测试网络

```bash
# c1
$ docker run -it --name c1 python bash
python -m http.server 12345

# c2
docker run -ti --name c2 busybox sh
```



## 测试1: 首先通过容器内部,来 ping

观察日志输出:

```bash
Sep 11 09:54:12 localhost kernel: TRACE: raw:PREROUTING:policy:2 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: mangle:PREROUTING:policy:1 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: nat:PREROUTING:policy:2 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: mangle:FORWARD:policy:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:FORWARD:rule:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:DOCKER-USER:return:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:FORWARD:rule:2 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:FORWARD:rule:4 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:DOCKER:return:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:FORWARD:rule:6 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: nat:POSTROUTING:policy:2 IN= OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b SRC=172.17.0.3 DST=172.17.0.2 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=19987 DF PROTO=ICMP TYPE=8 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: raw:PREROUTING:policy:2 IN=docker0 OUT= PHYSIN=vethb6fa51b MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: mangle:PREROUTING:policy:1 IN=docker0 OUT= PHYSIN=vethb6fa51b MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: mangle:FORWARD:policy:1 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:FORWARD:rule:1 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:DOCKER-USER:return:1 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:FORWARD:rule:2 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: filter:FORWARD:rule:3 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
Sep 11 09:54:12 localhost kernel: TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 SRC=172.17.0.2 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=39707 PROTO=ICMP TYPE=0 CODE=0 ID=9 SEQ=0
```

1. 首先 `c2 ping c1` 容器地址, 
2. c1 通过路由表发现, `172.17.0.0` 网段的包都通过容器内部的 `eth0` 接口, 这个接口是由 `veth piar` 对创建出来的用来连接, `docker0`  
3. 此时数据包到达 iptables 的 nat 表中的 `PREROUTING` 链,判断目标地址是否发往本机.
4. 进过路由选择,发现是转发到其他主机.进过 `filter` 中的 `foreword` 链
5. 最后经由 `nat` 表中的 `POSTROUTING` 链出去.
6. 回来的包,按照连接跟踪表的记录将包转出去.



## 测试2: 容器间 HTTP 通信

```bash
Sep 11 10:04:30 localhost kernel: TRACE: raw:PREROUTING:policy:3 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107727 ACK=0
WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:PREROUTING:policy:1 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107727 ACK
=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: nat:PREROUTING:policy:2 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107727 ACK=0
WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:FORWARD:policy:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=
12345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12
345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:DOCKER-USER:return:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788
DPT=12345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:2 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12
345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=T
CP SPT=60788 DPT=12345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:4 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12
345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:DOCKER:return:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=1
2345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:6 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12
345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00
SYN URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: nat:POSTROUTING:policy:2 IN= OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b SRC=172.17.0.3 DST=172.17.0.2 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=31841 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107727 ACK=0 WINDOW=64240 RES=0x00 SYN
 URGP=0 OPT (020405B40402080A9C2BCCC40000000001030307)
Sep 11 10:04:30 localhost kernel: TRACE: raw:PREROUTING:policy:3 IN=docker0 OUT= PHYSIN=vethb6fa51b MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=60788 SEQ=334704218 ACK=2612107
728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:PREROUTING:policy:1 IN=docker0 OUT= PHYSIN=vethb6fa51b MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=60788 SEQ=334704218 ACK=2612
107728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:FORWARD:policy:1 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=6078
8 SEQ=334704218 ACK=2612107728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:1 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=60788
SEQ=334704218 ACK=2612107728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:DOCKER-USER:return:1 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=
60788 SEQ=334704218 ACK=2612107728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:2 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=60788
SEQ=334704218 ACK=2612107728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP S
PT=12345 DPT=60788 SEQ=334704218 ACK=2612107728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:3 IN=docker0 OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 MAC=02:42:ac:11:00:03:02:42:ac:11:00:02:08:00 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=60788
SEQ=334704218 ACK=2612107728 WINDOW=65160 RES=0x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 PHYSIN=vethb6fa51b PHYSOUT=veth743fa57 SRC=172.17.0.2 DST=172.17.0.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=12345 DPT=60788 SEQ=334704218 ACK=2612107728 WINDOW=65160 RES=0
x00 ACK SYN URGP=0 OPT (020405B40402080AC17A3E169C2BCCC401030307)
Sep 11 10:04:30 localhost kernel: TRACE: raw:PREROUTING:policy:3 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107728 ACK=33
4704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:PREROUTING:policy:1 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107728 ACK
=334704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:FORWARD:policy:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788 DPT=
12345 SEQ=2612107728 ACK=334704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788 DPT=12
345 SEQ=2612107728 ACK=334704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: filter:DOCKER-USER:return:1 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788
DPT=12345 SEQ=2612107728 ACK=334704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:2 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788 DPT=12
345 SEQ=2612107728 ACK=334704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=T
CP SPT=60788 DPT=12345 SEQ=2612107728 ACK=334704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: filter:FORWARD:rule:3 IN=docker0 OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b MAC=02:42:ac:11:00:02:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788 DPT=12
345 SEQ=2612107728 ACK=334704219 WINDOW=502 RES=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
Sep 11 10:04:30 localhost kernel: TRACE: mangle:POSTROUTING:policy:1 IN= OUT=docker0 PHYSIN=veth743fa57 PHYSOUT=vethb6fa51b SRC=172.17.0.3 DST=172.17.0.2 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=31842 DF PROTO=TCP SPT=60788 DPT=12345 SEQ=2612107728 ACK=334704219 WINDOW=502 RES
=0x00 ACK URGP=0 OPT (0101080A9C2BCCC4C17A3E16)
```



1. 首先数据包经过 `nat:PREROUTING` 
2. 通过路由判断发现不是本地的包 通过 `filter:FORWARD`
3. 经由 `nat:POSTROUTING` 出去
4. 上面全部流程 也就是 3次握手的包





## 容器内部访问互联网

```bash
Sep 11 10:21:49 localhost kernel: TRACE: raw:PREROUTING:policy:3 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: mangle:PREROUTING:policy:1 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: nat:PREROUTING:policy:2 IN=docker0 OUT= PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=64 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: mangle:FORWARD:policy:1 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:FORWARD:rule:1 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:DOCKER-USER:return:1 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:FORWARD:rule:2 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:rule:1 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-2:return:2 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:FORWARD:rule:5 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: mangle:POSTROUTING:policy:1 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: nat:POSTROUTING:rule:1 IN=docker0 OUT=enp0s5 PHYSIN=veth743fa57 MAC=02:42:e8:dd:b4:a1:02:42:ac:11:00:03:08:00 SRC=172.17.0.3 DST=39.156.66.18 LEN=84 TOS=0x00 PREC=0x00 TTL=63 ID=4895 DF PROTO=ICMP TYPE=8 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: raw:PREROUTING:policy:3 IN=enp0s5 OUT= MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=10.211.55.8 LEN=84 TOS=0x00 PREC=0x00 TTL=128 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: mangle:PREROUTING:policy:1 IN=enp0s5 OUT= MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=10.211.55.8 LEN=84 TOS=0x00 PREC=0x00 TTL=128 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: mangle:FORWARD:policy:1 IN=enp0s5 OUT=docker0 MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=127 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:FORWARD:rule:1 IN=enp0s5 OUT=docker0 MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=127 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:DOCKER-USER:return:1 IN=enp0s5 OUT=docker0 MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=127 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:FORWARD:rule:2 IN=enp0s5 OUT=docker0 MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=127 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:DOCKER-ISOLATION-STAGE-1:return:2 IN=enp0s5 OUT=docker0 MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=127 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: filter:FORWARD:rule:3 IN=enp0s5 OUT=docker0 MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=127 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
Sep 11 10:21:49 localhost kernel: TRACE: mangle:POSTROUTING:policy:1 IN=enp0s5 OUT=docker0 MAC=00:1c:42:0d:c8:35:00:1c:42:00:00:18:08:00 SRC=39.156.66.18 DST=172.17.0.3 LEN=84 TOS=0x00 PREC=0x00 TTL=127 ID=44257 PROTO=ICMP TYPE=0 CODE=0 ID=13 SEQ=0
```



1. 前面数据包一致
2. 当数据包经过路由选择,发现需要从本地的 `enp0s5` 网卡出去
3. 于是在经过 `nat:POSTROUTING` 时候将源地址改写为了本地的 `10.211.55.8`
4. 当数据包回来的时候通过 SNAT 转换的地址原路返回.





## 流程图 

![QhElZOdYkFxMySn](https://i.loli.net/2021/09/13/QhElZOdYkFxMySn.jpg)

还有一张网上参考的图片也很清晰:

![YyziBlDRKxhjMOg](https://i.loli.net/2021/09/13/YyziBlDRKxhjMOg.png)

## 总结

1. MASQUERADE target: 这个target和SNAT target的作用是一样的，区别就是它不需要指定–to-source 。MASQUERADE是被专门设计用于那些动态获取IP地址的连接的，比如，拨号上网、DHCP连接等。如果你 有固定的IP地址，还是用SNAT target吧。

2. 每个数据包流向都存在连接跟踪表
3. docker0 是一个网桥设备,也是一个实际的网卡,可以用于容器内部的 gw 地址

